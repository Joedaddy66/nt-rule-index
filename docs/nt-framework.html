# ===== FULL AUTO: scaffold + commit + create GitHub repo + push =====
# Owner/repo
$User    = "Joedaddy66"
$Repo    = "nt-rule-index"
$Remote  = "https://github.com/$User/$Repo.git"
# Local path (change if you want another location)
$RepoPath = Join-Path $HOME "Documents\$Repo"

# ---------- helpers ----------
function Write-File { param([string]$Path,[string]$Content)
  New-Item -ItemType Directory -Force -Path (Split-Path $Path) | Out-Null
  $Content | Set-Content -Encoding utf8 $Path
}
function Warn($m){ Write-Host "WARNING: $m" -ForegroundColor Yellow }
function Info($m){ Write-Host $m -ForegroundColor Cyan }

# ---------- create folders ----------
New-Item -ItemType Directory -Force -Path $RepoPath,
  "$RepoPath\docs","$RepoPath\data","$RepoPath\scripts","$RepoPath\.github\workflows" | Out-Null

# ---------- core files ----------
Write-File (Join-Path $RepoPath ".gitignore") @'
__pycache__/
*.pyc
.env
site/
'@

Write-File (Join-Path $RepoPath "README.md") @'
# NT Rule Index
Local-first repository linking Drive artifacts to **Number-Theory Rule Packs** and publishing a MkDocs site.

## Quick start
- Build index: `python scripts/build_index.py`
- Install docs deps: `pip install -r requirements.txt`
- Serve locally: `mkdocs serve` → http://127.0.0.1:8000
'@

Write-File (Join-Path $RepoPath "RULE_PACKS.json") @'
{
  "FACTORIZATION": { "title": "Factorization & Smoothness", "desc": "ECM/QS/GNFS behavior, semiprimes, smoothness, divisor metrics." },
  "RSA_STRUCTURE": { "title": "RSA Structure (p,q geometry, λ)", "desc": "Keygen heuristics, |p - q| effects, λ-resilience." },
  "ANALYTIC_PROB_NT": { "title": "Analytic/Probabilistic NT", "desc": "Prime density, sieves, PNT-adjacent heuristics." },
  "SPECTRAL_METHODS": { "title": "Spectral / Frequency Methods", "desc": "Fourier views on primes, gaps, and numerical signals." },
  "ENTROPY_FEATURES": { "title": "Entropy & Feature Engineering", "desc": "Bond Strength (BS), anchors, eigenstates, primorial hubs." },
  "CRYPTO_POLICY_PQC": { "title": "Crypto Policy & PQC Transition", "desc": "Risk posture, migration guidance, hybrid schedules." }
}
'@

Write-File (Join-Path $RepoPath "data\index.csv") @'
id,title,source,drive_url,tags,summary,next_action,notes
doc-lambda-law,Universal λ-Resilience Law (draft),Google Drive,,RSA_STRUCTURE;FACTORIZATION;CRYPTO_POLICY_PQC,"Defines λ and benchmarks GNFS/ECM bite points.","Add figures + GNFS stage notes.",""
sheet-bs,Bond Strength Series (n, BS),Google Drive,,ENTROPY_FEATURES;ANALYTIC_PROB_NT,"Raw BS for features + entropy mapping.","Backfill metadata + ranges.",""
deck-srf,Spartan Resilience Framework (slides),Google Drive,,ENTROPY_FEATURES;CRYPTO_POLICY_PQC,"Framing: Bond Strength Law; safeguards.","Sync slides to latest terminology.",""
doc-doctrine,Doctrine of Frequency (Open Codex),Google Drive,,SPECTRAL_METHODS;ANALYTIC_PROB_NT;ENTROPY_FEATURES,"Harmonic lens, anchors, eigenstates.","Add spectral figures + references.",""
'@

Write-File (Join-Path $RepoPath "scripts\build_index.py") @'
import csv, json, os
from collections import defaultdict

ROOT = os.path.dirname(os.path.dirname(__file__))
RULE_JSON = os.path.join(ROOT, "RULE_PACKS.json")
CSV_PATH  = os.path.join(ROOT, "data", "index.csv")
OUT_MD    = os.path.join(ROOT, "docs", "index.md")

def load_rules():
    with open(RULE_JSON, "r", encoding="utf-8") as f:
        return json.load(f)

def read_rows():
    with open(CSV_PATH, "r", encoding="utf-8") as f:
        return list(csv.DictReader(f))

def normalize_tags(s):
    if not s: return []
    return [t.strip() for t in s.split(";") if t.strip()]

def md_link(title, url):
    return f"[{title}]({url})" if url and url.strip() else title

def build_index(rows, rules):
    by_tag = defaultdict(list)
    for row in rows:
        for t in normalize_tags(row.get("tags","")):
            by_tag[t].append(row)

    tag_order = list(rules.keys()) + sorted([t for t in by_tag.keys() if t not in rules])

    lines = []
    lines.append("# Number-Theory Rule Index\n")
    lines.append("_Auto-generated from `data/index.csv`_\n")
    lines.append("## Rule Packs\n")
    for key in rules:
        lines.append(f"- **{key}** — {rules[key].get('title','')}: {rules[key].get('desc','')}")
    lines.append("\n---\n")

    for t in tag_order:
        if t not in by_tag: continue
        title = rules.get(t, {}).get("title", t)
        lines.append(f"## {title} ({t})\n")
        for row in sorted(by_tag[t], key=lambda r: r.get("title","").lower()):
            link = md_link(row.get("title","(untitled)"), row.get("drive_url",""))
            summary = (row.get("summary","") or "").strip()
            next_action = (row.get("next_action","") or "").strip()
            notes = (row.get("notes","") or "").strip()
            meta = ", ".join([m for m in [row.get("source","").strip(), row.get("id","").strip()] if m])
            lines.append(f"- {link}  \n  _{meta}_  \n  {summary}")
            if next_action: lines.append(f"  \n  **Next:** {next_action}")
            if notes: lines.append(f"  \n  **Notes:** {notes}")
            lines.append("")
        lines.append("---\n")
    return "\n".join(lines).rstrip() + "\n"

if __name__ == "__main__":
    rules = load_rules()
    rows  = read_rows()
    os.makedirs(os.path.join(ROOT,"docs"), exist_ok=True)
    with open(OUT_MD, "w", encoding="utf-8") as f:
        f.write(build_index(rows, rules))
    print(f"Wrote {OUT_MD}")
'@

Write-File (Join-Path $RepoPath "docs\index.md") "# Number-Theory Rule Index`n`n*(seed page; run build_index.py to regenerate)*"

# SPA HTML (from clipboard, or stub)
$SpaPath = Join-Path $RepoPath "docs\nt-framework.html"
$clip = ""; try { $clip = Get-Clipboard -Raw } catch { $clip = "" }
if (-not $clip -or ($clip.Trim()).Length -eq 0) {
  Warn "Clipboard empty; writing a stub SPA. Overwrite docs\nt-framework.html with your full HTML later."
  Write-File $SpaPath @'
<!DOCTYPE html><html><head><meta charset="utf-8"><title>NT Framework (Stub)</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>body{font-family:Inter,system-ui,sans-serif;background:#FDFBF8;color:#40322C}</style>
</head><body class="p-8"><h1 class="text-3xl font-bold mb-2">NT Framework (Stub)</h1>
<p>Replace this file with your full SPA HTML.</p></body></html>
'@
} else {
  Write-File $SpaPath $clip
}

# MkDocs + requirements
Write-File (Join-Path $RepoPath "mkdocs.yml") @'
site_name: NT Rule Index
theme:
  name: material
  features:
    - navigation.instant
    - navigation.sections
    - content.code.copy
nav:
  - Home: index.md
  - NT Framework (SPA): nt-framework.html
markdown_extensions:
  - toc:
      permalink: true
  - admonition
  - footnotes
  - attr_list
extra:
  generator: false
'@

Write-File (Join-Path $RepoPath "requirements.txt") @'
mkdocs>=1.6
mkdocs-material>=9.5
'@

# GitHub Actions workflow
Write-File (Join-Path $RepoPath ".github\workflows\site-deploy.yml") @'
name: site-deploy
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build docs index (CSV -> docs/index.md)
        run: |
          if [ -f scripts/build_index.py ]; then
            python scripts/build_index.py || echo "build_index.py failed (continuing)"
          fi
      - name: Install MkDocs
        run: pip install -r requirements.txt
      - name: Build site
        run: mkdocs build --strict --verbose
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
'@

# ---------- git init + commit ----------
Push-Location $RepoPath
$hasGit = $true; try { git --version | Out-Null } catch { $hasGit = $false }
if ($hasGit) {
  if (-not (Test-Path (Join-Path $RepoPath ".git"))) { try { git init -b main | Out-Null } catch { git init | Out-Null; git branch -M main } }
  git add -A
  try { git commit -m "init: NT Rule Index scaffold + SPA + MkDocs + CI" | Out-Null } catch { }
} else {
  Warn "Git not in PATH. Install Git and re-run push section later."
}
Pop-Location

# ---------- create GitHub repo + push ----------
$useGh = $false; try { if (Get-Command gh -ErrorAction Stop) { $useGh = $true } } catch { $useGh = $false }

function CreateRepoViaAPI {
  param([string]$Owner,[string]$Name,[bool]$Private=$false)
  $token = $env:GITHUB_TOKEN; if (-not $token) { $token = $env:GH_TOKEN }
  if (-not $token) {
    Warn "No gh CLI and no GITHUB_TOKEN/GH_TOKEN found. Cannot auto-create repo."
    Write-Host "Create it manually: https://github.com/new?owner=$Owner&name=$Name&visibility=public"
    return $false
  }
  $body = @{ name = $Name; private = $Private } | ConvertTo-Json
  try {
    $resp = Invoke-RestMethod -Method POST -Uri "https://api.github.com/user/repos" -Headers @{Authorization="token $token"; "User-Agent"="ps-github"} -Body $body
    return $true
  } catch {
    Warn "GitHub API create failed: $($_.Exception.Message)"
    return $false
  }
}

Push-Location $RepoPath
if ($hasGit) {
  $created = $false
  if ($useGh) {
    try {
      gh repo view "$User/$Repo" 2>$null | Out-Null
    } catch {
      Info "Creating repo on GitHub with gh…"
      gh repo create "$User/$Repo" --public --source . --remote origin --push | Out-Null
      $created = $true
    }
    if (-not $created) {
      try { git remote get-url origin | Out-Null } catch { git remote add origin $Remote }
      git push -u origin main
    }
  } else {
    # No gh: try API or require manual creation
    try { git remote get-url origin | Out-Null } catch { git remote add origin $Remote }
    $ok = CreateRepoViaAPI -Owner $User -Name $Repo -Private:$false
    git push -u origin main
    if ($LASTEXITCODE -ne 0 -and -not $ok) {
      Warn "Push failed. Create repo manually at: https://github.com/new?owner=$User&name=$Repo&visibility=public"
      Write-Host "Then run: git push -u origin main"
    }
  }
}
Pop-Location

# ---------- open pages ----------
Start-Process "https://github.com/$User/$Repo/actions"
Start-Process "https://$User.github.io/$Repo/nt-framework.html"

Write-Host "`n✅ Done. Repo path: $RepoPath  |  Remote: $Remote"
Write-Host "If the site 404s, wait for Actions to finish, then refresh."

